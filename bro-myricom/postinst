#!/bin/sh

set -e

case "$1" in
    configure)
        
        # if upgrading from 2.3, copy over user's config
        if [ -d /opt/bro/etc_2.3 ]; then
            cp /opt/bro/etc_2.3/* /opt/bro/etc/ || echo "Unable to restore Bro 2.3 config."
        fi

        # check for 172.16 in networks.cfg
        if ! grep "172.16" /opt/bro/etc/networks.cfg >/dev/null; then
		echo "172.16.0.0/12       Private IP space" >> /opt/bro/etc/networks.cfg
	fi

        # check broctl.cfg for proper dirs
        if ! grep "nsm" /opt/bro/etc/broctl.cfg >/dev/null; then
                sed -i 's|SpoolDir = /var/opt/bro/spool|SpoolDir = /nsm/bro/spool|g' /opt/bro/etc/broctl.cfg
                sed -i 's|LogDir = /var/opt/bro/logs|LogDir = /nsm/bro/logs|g' /opt/bro/etc/broctl.cfg
        fi

        # create the /nsm/bro/ directories if they don't already exist
        mkdir -p /nsm/bro/spool
        mkdir -p /nsm/bro/logs

        # Bro 2.2 supports multiple PF_RING workers on multiple interfaces
        # so enable any lb_* directives that we had previously commented out
        # sed -i 's|#lb_|lb_|g' /opt/bro/etc/node.cfg

        # fix broctl-config.sh symlink
        rm /opt/bro/share/broctl/scripts/broctl-config.sh
        ln -s /nsm/bro/spool/broctl-config.sh /opt/bro/share/broctl/scripts/broctl-config.sh

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;


    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
